<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography,aspect-ratio"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora&display=swap" >
    <script src="https://unpkg.com/htmx.org@1.9.2" integrity="sha384-L6OqL9pRWyyFU3+/bjdSri+iIphTN/bvYyM37tICVyOJkWZLpP2vGn6VUEXgzg6h" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
    <style>
        .input-wrapper {
            transition: all 0.5s ease-in-out;
            min-height: 50px;
            max-height: 200px;
            overflow: auto;
        }
        body {
            font-family: 'Inconsolata', serif;
        }    
    </style> 
</head>
<body id="body" class="bg-gray-100">
    <div class="fixed left-0 top-0 p-4 flex invisible lg:visible">
        <span class="self-center text-2xl font-semibold whitespace-nowrap text-gray-400 dark:text-white">a|os</span>
     </div>
     
    <div id="messages-container" hx-ext="sse" sse-connect="{{messages_sse_url}}" >
        <div 
            hx-get="messages" 
            hx-trigger="load, sse:receipt" 
            hx-vals="js:{messagekey: getQueryVals(event)}" 
            hx-swap="beforeend"
            @htmx:sse-message.camel="$el.scrollIntoView(false)"
            class="chat-container px-4 py-6 max-w-4xl mx-auto mb-20">
        </div>
    </div>

    <div class="chat-input-container fixed bottom-0 left-0 right-0 p-2 bg-gray-100 border-t border-gray-200">
        <div class="relative flex items-center max-w-4xl mx-auto pl-14">
            <div id="chat-input-wrapper" class="input-wrapper flex-1 bg-white border border-gray-300 rounded">
                <textarea id="chat-input" class="w-full p-2 pr-8 outline-none resize-none" placeholder="Type a message..."></textarea>
            </div>
            <button id="send-button" class="absolute right-4 bottom-1/2 transform translate-y-1/2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-6 w-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        agent_inbox_url = "{{actor_inbox_url}}"
        actor_id = "{{actor_id}}"
        
        function getQueryVals(e){
            console.log('Event:', e);
            if(e && e.type == 'receipt'){
                data = JSON.parse(e.data);
                if(data.sender_id == actor_id && data.content != null){
                    return data.content;
                }
            }
            return null;
        }
        
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');


        // Expands the textarea to fit its content
        chatInput.addEventListener('input', function() {
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Sends the message when Enter is pressed, and adds a new line when Ctrl+Enter is pressed
        chatInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                if (!event.shiftKey) {
                    // Prevent the default "Enter" behaviour (adding a new line)
                    event.preventDefault();
                    // Send the message (you'll need to implement this function yourself)
                    sendMessage();
                }
            }
        });

        // Sends the message when the button is clicked
        sendButton.addEventListener('click', sendMessage);
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                console.log('Sending message:', message);
                // Send the message (you'll need to implement this function yourself)
                fetch(agent_inbox_url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: message
                });
                // Clear the input
                chatInput.value = '';
                chatInput.style.height = 'auto';
            }
        }

        htmx.on('htmx:afterSwap', function(evt) {
            window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
        });
    </script>
</body>
</html>
